# Prompt-to-Prompt Image Editing with Cross Attention Control | Image editing, Image generation

## 1. 핵심 주장 및 주요 기여  
이 논문은 **기존 텍스트-투-이미지 확산 모델**의 내부에 숨겨진 **크로스어텐션(Cross-Attention) 맵**을 직접 제어함으로써, 사용자가 오직 **텍스트 프롬프트만** 수정하여 원본 이미지를 **직관적으로** 편집할 수 있음을 보여준다.  
- 프롬프트 내 특정 단어의 어텐션 맵을 주입하여 원본 이미지의 **공간적 구성**(geometry)과 **세부 구조**를 보존  
- 새로운 단어 추가, 단어 대체, 어텐션 강도 조절(fader control) 등 다양한 텍스트 편집 방식 지원  
- 별도의 **마스크**나 **추가 학습** 없이, 사전학습된 모델만으로 동작  

## 2. 문제 정의  
- **기존 한계**: 텍스트만을 변경하면 확산 모델 출력이 완전히 달라져, 일부만 수정하기 어렵고(예: ‘dog’→‘cat’), 마스크 기반 방법은 번거롭고 구조 정보가 소실됨  
- **목표**: 원본 이미지의 大‒小 범위 편집을 모두 지원하면서, 오직 *프롬프트 텍스트* 변경만으로 이미지 편집을 가능케 하는 직관적 인터페이스 제공  

## 3. 제안 방법  
### 3.1 크로스어텐션 기반 이미지 생성  
확산 단계 $$t$$에서 노이즈 $$z_t$$와 프롬프트 임베딩 $$\psi(P)$$를 입력으로, U-Net 내 크로스어텐션 연산을 통해 노이즈 제거를 수행  

$$
Q = \ell_Q(\phi(z_t)),\quad
K = \ell_K(\psi(P)),\quad
V = \ell_V(\psi(P))
$$

$$
M_t = \mathrm{Softmax}\!\bigl(\tfrac{QK^\top}{\sqrt{d}}\bigr),\quad
\tilde\phi(z_t) = M_t\,V
$$  

여기서 $$M_t\in\mathbb{R}^{\text{pixels}\times\text{tokens}}$$은 각 토큰이 픽셀에 미치는 영향도를 나타내는 **어텐션 맵**이다.

### 3.2 Prompt-to-Prompt 편집 알고리즘  
원본 프롬프트 $$P$$와 수정 프롬프트 $$P^*$$에 대해 동일 시드 $$s$$로 역·정방향 확산을 병렬 수행하며, 단계별로 어텐션 맵을 합성  
```
for t = T → 1:
    (z_{t-1}, M_t) ← DM(z_t, P, t, s)
    M^*_t ← DM(z^*_t, P^*, t, s)  # 편집 프롬프트로부터 어텐션
    \hat M_t ← Edit(M_t, M^*_t, t)
    z^*_{t-1} ← DM(z^*_t, P^*, t, s){M←\hat M_t}
```
- **Word Swap** (단어 대체):  

  $$\hat M_t = M_t$$ for $$t \ge \tau$$, $$\hat M_t = M^*_t$$ for $$t < \tau$$  

  → 초기 단계($$<\tau$$)에만 원본 어텐션 주입하여 레이아웃 보존  
- **Adding New Phrase** (단어 추가):  
  공통 토큰 인덱스 매칭 함수 $$A(j)$$를 이용해  

```math
    \hat M_{i,j} =
    \begin{cases}
      (M_t)_{i,A(j)}, & A(j)\neq\varnothing,\\
      (M^*_t)_{i,j}, & A(j)=\varnothing.
    \end{cases}
```

- **Attention Re-weighting** (어텐션 강도 조절):  
  지정 토큰 $$j^* $$ 에 대해 $$\hat M\_{i,j^* }=c\cdot (M_t)\_{i,j^* }$$, 나머지는 그대로  

## 4. 모델 구조  
- 64×64 해상도 텍스트→이미지 확산 모델(U-Net)  
  - 저해상도 크로스어텐션 & 결합(Self+Cross) 어텐션  
- 64→256, 256→1024 슈퍼레졸루션 U-Net  
  - 병목층(bottleneck)에서만 크로스어텐션  

## 5. 성능 향상 및 실험 결과  
- **질감·구조 편집**: ‘lemon cake’→‘pumpkin cake’ 시 레이아웃·색상·디테일 보존  
- **구조적 대체**: ‘bicycle’→‘car’ 등 대형 객체 교체에서도 원본구조 유지  
- **스타일·분위기**: 스케치→사진, 수채화→유화 스타일 전환 시도  
- **어텐션 페이더**: 단어별 영향력 조절로 눈에 띄는 제어성 확보  
- **실제 이미지 편집**: DDIM 역확산(inversion) 기법 적용 후 어텐션 마스크로 미편집 영역 보존  

## 6. 한계  
- **역확산 정확도**: DDIM 기반 inversion이 일부 입력 이미지에서 왜곡 발생  
- **프롬프트 의존성**: 복잡 구성을 위해 사용자가 알맞은 원본 프롬프트를 제시해야 함  
- **해상도 제약**: 병목층 어텐션 맵 해상도가 낮아 미세 편집 한계  
- **객체 이동 제어 미구현**: 기존 객체를 이미지 내에서 공간 이동하는 기능 부재  

## 7. 일반화 성능 향상 가능성  
- 더 높은 해상도 층에도 크로스어텐션 적용 시 **공간적 세밀함 증가**  
- 역확산 과정에서 **클래스파이어-프리 가이던스** 최적화로 **보존·편집 간 균형** 조절  
- 다양한 **확산 백본**(e.g., Latent Diffusion) 및 멀티모달 모델에 Prompt-to-Prompt 적용  

## 8. 향후 연구 영향 및 고려 사항  
- **직관적 텍스트 편집**: 사용자 친화적 이미지 편집 인터페이스 발전  
- **크로스어텐션 해석 연구**: 어텐션 맵의 **시맨틱·공간 정보** 이해 확대  
- **더 나은 역확산 기법**: 실 사진 편집을 위한 정확도·효율성 개선 반드시 필요  
- **동적 어텐션 해상도**: 레이어별 어텐션 제어를 통한 **지역적 편집 정밀도** 강화  

Prompt-to-Prompt 기법은 텍스트만으로도 매우 다양한 이미지 편집 시나리오를 지원함으로써, 차세대 텍스트-기반 이미지 생성·편집 연구에 핵심적인 **프롬프트 제어 메커니즘**으로 자리잡을 전망이다.

[1] https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/22370781/a94c1666-f473-4911-b85f-df464088949b/2208.01626v1.pdf
