# Models for shape
이 장에서는 2D 및 3D 형태 모델에 대해 다루고 있습니다. 형태 모델의 동기는 두 가지입니다. 

첫째, 장면에서 특정 객체에 속하는 픽셀을 정확히 식별하고자 합니다. 이를 위해 객체의 외곽 윤곽선을 명시적으로 모델링하는 접근 방법이 있습니다.

둘째, 형태는 객체의 정체성 또는 다른 특성을 나타낼 수 있습니다.

이 장에서는 기존의 방법들이 아닌 상향식 접근 방식 대신 하향식 접근 방식을 사용할 것입니다. 여기에서는 객체에 관한 사전 정보를 강제로 부여하여 가능한 윤곽 형태를 제약합니다.

의료 이미징 데이터를 이용한 척추의 2D 기하학적 모델 적합 문제를 예로 들어보겠습니다. 이 복잡한 형태를 몇 개의 파라미터로 특성화해야 함으로써, 이후의 진단 기초로 사용할 수 있습니다. 그러나 이미지 내의 로컬 엣지 정보가 약한 반면, 척추의 가능한 형태에 대한 강한 사전 지식이 유리하게 작용합니다.

## Shape and its representation
모양은 “위치, 크기 및 회전 효과가 필터링된 후 남는 모든 기하학적 정보”로 설명됩니다. 즉, 모양은 유사 변환에 불변한 기하학적 정보를 포함합니다.

각 상황에 따라 유클리드 또는 아핀과 같은 다른 변환 유형으로 이 정의를 일반화할 수도 있습니다.

대수적 모델은 윤곽에 대한 닫힌 형식 표현을 제공한다는 점에서 매력적이지만, 그 적용 가능성은 매우 제한적입니다. 복잡한 형태, 예를 들어 척추와 같은 형상을 설명하는 수학적 표현을 정의하기는 어려운 상황입니다.

이 장의 대부분의 모델은 다른 접근 방식을 채택하며 형태를 일련의 랜드마크 포인트를 사용하여 정의합니다. 랜드마크 포인트는 하나 또는 여러 개의 연속적인 윤곽선에서 이산 표본으로 생각할 수 있습니다. 랜드마크 포인트의 연결성은 모델에 따라 달라지며, 단일 연속 윤곽선을 나타내거나, 감싸여져 닫힌 윤곽선 또는 복잡한 구성으로 열린 윤곽선을 나타낼 수 있습니다.

랜드마크 포인트 간의 보간을 통해 윤곽선을 재구성할 수 있습니다. 예를 들어, 인접한 랜드마크 포인트를 직선으로 연결하여 윤곽선을 형성할 수 있습니다. 보다 정교한 방식에서는 랜드마크 포인트가 스플라인 모델의 제어점으로 작용하여 부드러운 곡선의 위치를 간접적으로 결정할 수 있습니다.

<img width="745" alt="스크린샷 2025-06-16 오후 9 52 21" src="https://github.com/user-attachments/assets/0301889e-2180-4d1a-ada5-e70b642539b6" />

## Snakes
모델 정의 : 매개변수적 윤곽선 모델

N개의 2D 랜드마크 포인트 W = [w1,w2,...,wN]의 구성을 찾는 것. 이 포인트들은 이미지 내 객체의 형태를 설명합니다.

생성 모델: 랜드마크 위치에 대한 생성 모델은 두 가지 주요 구성 요소로 이루어집니다.

우도항(likelihood term): 랜드마크 포인트가 이미지 데이터와 얼마나 잘 일치하는지를 나타냅니다.

사전항(prior term): 다양한 구성의 빈도에 대한 기존 지식을 포함합니다.

랜드마크 포인트가 이미지의 등고선 위에 있을 때, 적합성이 높으며, 그렇지 않을 경우 낮을 수 있습니다.

문제점: 이미지의 평평한 부분에서는 Sobel 엣지 연산자가 0을 반환하므로, 랜드마크 포인트가 평평한 부분에 위치할 경우, 적합성을 개선하기 위한 방향을 파악할 정보가 없다는 단점이 있습니다.

<img width="745" alt="스크린샷 2025-06-16 오후 10 07 58" src="https://github.com/user-attachments/assets/d8455f16-05f6-454d-81e7-b91d8196a873" />

랜드마크 포인트가 이미지의 엣지에 가까울수록 그 가능성이 커지며, 반대로 그 거리가 멀어질수록 가능성이 줄어드는 것은 직관적이고 또한 유용한 접근입니다.

강한 에지에 각각의 포인트가 개별적으로 끌리는 경우, 일관된 형태를 이루지 못할 수 있습니다.

이러한 문제를 피하고 모델을 완성하기 위해, 우리는 낮은 곡률을 가진 부드러운 윤곽을 선호하는 사전(prior)을 정의합니다.

### Inference
경계선 위의 점들을 최적화하고자 하는 과정

최적화가 진행됨에 따라, 윤곽선이 이미지 내에서 최고의 후방 확률을 가진 랜드마크 점들을 찾기 위해 움직이는 모습이 나타납니다. 이러한 이유로 이 윤곽선 모델은 종종 'snake' 또는 'active contour model'로 불립니다.

<img width="745" alt="스크린샷 2025-06-16 오후 10 13 44" src="https://github.com/user-attachments/assets/3cb3f06d-38d9-48ad-9317-8ae77abe1d38" />


얼핏 봤을 때, 최종 윤곽선은 고슴도치의 외부 경계를 잘 따라가지만, 코 부분을 올바르게 구분하지 못했습니다. 코 영역은 곡률이 높고, 이 부분의 규모는 인접한 랜드마크 점 간의 거리보다 작기 때문에 문제가 발생합니다. 이러한 모델은 랜드마크 점 간의 윤곽선을 따라 이미지에 의존하는 가능성을 사용함으로써 개선될 수 있습니다. 이렇게 하면 알려지지 않은 수가 적으면서도 이미지의 밀집된 정보를 활용하는 모델을 개발할 수 있습니다.

최적화 과정에서 지역 최적해에 갇히는 문제와 이미지의 밀도 있는 사용을 통해 모델을 개선하는 방법이 제시되고 있습니다.

모델 개선 방법:

랜드마크 점 사이의 간격에 이미지를 포함하는 가능성(likelihood)을 사용하여 모델을 개선할 수 있습니다.  
최적화 프로세스가 지역 최적값에 갇힐 수 있어, 여러 초기 조건에서 시작하여 가장 높은 확률을 가진 솔루션을 선택할 수 있습니다.

사전 수정:

간격 항(space term)을 정의하여 점들이 미리 정의된 값에 가깝게 배치되도록 유도할 수 있습니다.  
이 수정은 모델의 추론을 용이하게 하여 1D Markov random field 를 형성합니다.


### Problems with the snake model
간단한 스네이크 모델은 몇 가지 한계가 있습니다. 이 모델은 객체 경계의 매끄러움에 대한 정보가 부족하여 다음과 같은 상황에서는 유용하지 않습니다.  

- 이미지 내에서 객체의 위치는 알지만 형태가 불확실한 경우.  
- 객체의 클래스(예: 얼굴)는 알고 있지만 특정 인스턴스(예: 누구의 얼굴)는 모르는 경우.
- 2D 모델로서, 일부 윤곽선이 3D 표면의 카메라 모델을 통해 투영된 것임을 이해하지 못합니다.
- 인체와 같은 관절이 있는 객체를 모델링할 수 없습니다.

## Shape templates
이 모델은 이미지 내에서 객체의 위치, 스케일, 방향을 식별하는 데 초점을 맞추고 있습니다.

형태 템플릿 모델:

정확한 형태를 알고 있다고 가정. 객체의 위치, 크기, 방향을 조정.

변환 매개변수 Ψ:

객체의 형태를 이미지를 매핑하기 위한 파라미터 집합. 유사 변환(lambda)에서는 회전 각도, 스케일링 팩터, 2D 평행 이동 벡터로 구성.

데이터의 가능도:

관측된 이미지 데이터의 가능도는 변환 매개변수에 따라 결정됨. 객체의 랜드마크 포인트와 최단 거리와 관련된 식을 사용.

가능도 함수:
랜드마크 포인트가 이미지의 엣지 근처에 있을 때 가능도가 증가.

### Inference
템플릿 모델의 최적화 문제.

최대 우도(Maximum Likelihood) 접근 방식을 통해 변환 매개변수 Ψ를 찾는 과정.

최대 우도 추정:

로그 우도 L을 최대화하여 변환 매개변수 Ψ를 추정합니다.

비선형 최적화:

해석적 솔루션이 없으므로, 비선형 최적화 기법을 사용해야 합니다.  
목표 함수의 도함수를 계산하기 위해 연쇄 법칙을 사용합니다.

도함수 계산:

두 가지 컴포넌트를 포함:
거리의 변화량을 계산하는 첫 번째 항. 변환에 따라 달라지는 두 번째 항.

최적화 과정:

다양한 초기 위치에서 최적화를 재시작하고, 최적 우도를 선택하는 방식.

<img width="745" alt="스크린샷 2025-06-16 오후 10 23 39" src="https://github.com/user-attachments/assets/0adb779b-b2fd-4e28-9f4f-782282c90064" />

신뢰할 수 있는 최적화의 수렴이 보장되지 않는 점은 아쉬운 사항입니다. Snake 모델의 경우, 다음과 같은 방법으로 문제를 해결할 수 있습니다:

다양한 시작점 사용: 여러 위치에서 최적화를 재시작하여 전체 최대 로그 가능성을 가진 솔루션을 선택합니다.

초기화 개선: 예를 들어, 초기 위치를 얼굴 탐지기의 출력을 바탕으로 설정할 수 있습니다.

사전 지식 적용: 가능한 변환 파라미터에 대한 사전 지식을 사용하여 솔루션의 범위를 제한하고 최대 사후 확률(maximum a posteriori) 공식을 적용할 수 있습니다.

이와 같은 방법들을 통해 최적화 과정에서의 신뢰성을 높일 수 있습니다.

### Inference with iterative closest point algorithm
