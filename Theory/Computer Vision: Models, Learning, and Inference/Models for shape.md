# Models for shape
이 장에서는 2D 및 3D 형태 모델에 대해 다루고 있습니다. 형태 모델의 동기는 두 가지입니다. 

첫째, 장면에서 특정 객체에 속하는 픽셀을 정확히 식별하고자 합니다. 이를 위해 객체의 외곽 윤곽선을 명시적으로 모델링하는 접근 방법이 있습니다.

둘째, 형태는 객체의 정체성 또는 다른 특성을 나타낼 수 있습니다.

이 장에서는 기존의 방법들이 아닌 상향식 접근 방식 대신 하향식 접근 방식을 사용할 것입니다. 여기에서는 객체에 관한 사전 정보를 강제로 부여하여 가능한 윤곽 형태를 제약합니다.

의료 이미징 데이터를 이용한 척추의 2D 기하학적 모델 적합 문제를 예로 들어보겠습니다. 이 복잡한 형태를 몇 개의 파라미터로 특성화해야 함으로써, 이후의 진단 기초로 사용할 수 있습니다. 그러나 이미지 내의 로컬 엣지 정보가 약한 반면, 척추의 가능한 형태에 대한 강한 사전 지식이 유리하게 작용합니다.

## Shape and its representation
모양은 “위치, 크기 및 회전 효과가 필터링된 후 남는 모든 기하학적 정보”로 설명됩니다. 즉, 모양은 유사 변환에 불변한 기하학적 정보를 포함합니다.

각 상황에 따라 유클리드 또는 아핀과 같은 다른 변환 유형으로 이 정의를 일반화할 수도 있습니다.

대수적 모델은 윤곽에 대한 닫힌 형식 표현을 제공한다는 점에서 매력적이지만, 그 적용 가능성은 매우 제한적입니다. 복잡한 형태, 예를 들어 척추와 같은 형상을 설명하는 수학적 표현을 정의하기는 어려운 상황입니다.

이 장의 대부분의 모델은 다른 접근 방식을 채택하며 형태를 일련의 랜드마크 포인트를 사용하여 정의합니다. 랜드마크 포인트는 하나 또는 여러 개의 연속적인 윤곽선에서 이산 표본으로 생각할 수 있습니다. 랜드마크 포인트의 연결성은 모델에 따라 달라지며, 단일 연속 윤곽선을 나타내거나, 감싸여져 닫힌 윤곽선 또는 복잡한 구성으로 열린 윤곽선을 나타낼 수 있습니다.

랜드마크 포인트 간의 보간을 통해 윤곽선을 재구성할 수 있습니다. 예를 들어, 인접한 랜드마크 포인트를 직선으로 연결하여 윤곽선을 형성할 수 있습니다. 보다 정교한 방식에서는 랜드마크 포인트가 스플라인 모델의 제어점으로 작용하여 부드러운 곡선의 위치를 간접적으로 결정할 수 있습니다.

<img width="745" alt="스크린샷 2025-06-16 오후 9 52 21" src="https://github.com/user-attachments/assets/0301889e-2180-4d1a-ada5-e70b642539b6" />

## Snakes
모델 정의 : 매개변수적 윤곽선 모델

N개의 2D 랜드마크 포인트 W = [w1,w2,...,wN]의 구성을 찾는 것. 이 포인트들은 이미지 내 객체의 형태를 설명합니다.

생성 모델: 랜드마크 위치에 대한 생성 모델은 두 가지 주요 구성 요소로 이루어집니다.

우도항(likelihood term): 랜드마크 포인트가 이미지 데이터와 얼마나 잘 일치하는지를 나타냅니다.

사전항(prior term): 다양한 구성의 빈도에 대한 기존 지식을 포함합니다.

랜드마크 포인트가 이미지의 등고선 위에 있을 때, 적합성이 높으며, 그렇지 않을 경우 낮을 수 있습니다.

문제점: 이미지의 평평한 부분에서는 Sobel 엣지 연산자가 0을 반환하므로, 랜드마크 포인트가 평평한 부분에 위치할 경우, 적합성을 개선하기 위한 방향을 파악할 정보가 없다는 단점이 있습니다.

<img width="745" alt="스크린샷 2025-06-16 오후 10 07 58" src="https://github.com/user-attachments/assets/d8455f16-05f6-454d-81e7-b91d8196a873" />

랜드마크 포인트가 이미지의 엣지에 가까울수록 그 가능성이 커지며, 반대로 그 거리가 멀어질수록 가능성이 줄어드는 것은 직관적이고 또한 유용한 접근입니다.

강한 에지에 각각의 포인트가 개별적으로 끌리는 경우, 일관된 형태를 이루지 못할 수 있습니다.

이러한 문제를 피하고 모델을 완성하기 위해, 우리는 낮은 곡률을 가진 부드러운 윤곽을 선호하는 사전(prior)을 정의합니다.

### Inference
경계선 위의 점들을 최적화하고자 하는 과정

최적화가 진행됨에 따라, 윤곽선이 이미지 내에서 최고의 후방 확률을 가진 랜드마크 점들을 찾기 위해 움직이는 모습이 나타납니다. 이러한 이유로 이 윤곽선 모델은 종종 'snake' 또는 'active contour model'로 불립니다.

<img width="745" alt="스크린샷 2025-06-16 오후 10 13 44" src="https://github.com/user-attachments/assets/3cb3f06d-38d9-48ad-9317-8ae77abe1d38" />


얼핏 봤을 때, 최종 윤곽선은 고슴도치의 외부 경계를 잘 따라가지만, 코 부분을 올바르게 구분하지 못했습니다. 코 영역은 곡률이 높고, 이 부분의 규모는 인접한 랜드마크 점 간의 거리보다 작기 때문에 문제가 발생합니다. 이러한 모델은 랜드마크 점 간의 윤곽선을 따라 이미지에 의존하는 가능성을 사용함으로써 개선될 수 있습니다. 이렇게 하면 알려지지 않은 수가 적으면서도 이미지의 밀집된 정보를 활용하는 모델을 개발할 수 있습니다.

최적화 과정에서 지역 최적해에 갇히는 문제와 이미지의 밀도 있는 사용을 통해 모델을 개선하는 방법이 제시되고 있습니다.

모델 개선 방법:

랜드마크 점 사이의 간격에 이미지를 포함하는 가능성(likelihood)을 사용하여 모델을 개선할 수 있습니다.  
최적화 프로세스가 지역 최적값에 갇힐 수 있어, 여러 초기 조건에서 시작하여 가장 높은 확률을 가진 솔루션을 선택할 수 있습니다.

사전 수정:

간격 항(space term)을 정의하여 점들이 미리 정의된 값에 가깝게 배치되도록 유도할 수 있습니다.  
이 수정은 모델의 추론을 용이하게 하여 1D Markov random field 를 형성합니다.


### Problems with the snake model
간단한 스네이크 모델은 몇 가지 한계가 있습니다. 이 모델은 객체 경계의 매끄러움에 대한 정보가 부족하여 다음과 같은 상황에서는 유용하지 않습니다.  

- 이미지 내에서 객체의 위치는 알지만 형태가 불확실한 경우.  
- 객체의 클래스(예: 얼굴)는 알고 있지만 특정 인스턴스(예: 누구의 얼굴)는 모르는 경우.
- 2D 모델로서, 일부 윤곽선이 3D 표면의 카메라 모델을 통해 투영된 것임을 이해하지 못합니다.
- 인체와 같은 관절이 있는 객체를 모델링할 수 없습니다.

## Shape templates
이 모델은 이미지 내에서 객체의 위치, 스케일, 방향을 식별하는 데 초점을 맞추고 있습니다.

형태 템플릿 모델:

정확한 형태를 알고 있다고 가정. 객체의 위치, 크기, 방향을 조정.

변환 매개변수 Ψ:

객체의 형태를 이미지를 매핑하기 위한 파라미터 집합. 유사 변환(lambda)에서는 회전 각도, 스케일링 팩터, 2D 평행 이동 벡터로 구성.

데이터의 가능도:

관측된 이미지 데이터의 가능도는 변환 매개변수에 따라 결정됨. 객체의 랜드마크 포인트와 최단 거리와 관련된 식을 사용.

가능도 함수:
랜드마크 포인트가 이미지의 엣지 근처에 있을 때 가능도가 증가.

### Inference
템플릿 모델의 최적화 문제.

최대 우도(Maximum Likelihood) 접근 방식을 통해 변환 매개변수 Ψ를 찾는 과정.

최대 우도 추정:

로그 우도 L을 최대화하여 변환 매개변수 Ψ를 추정합니다.

비선형 최적화:

해석적 솔루션이 없으므로, 비선형 최적화 기법을 사용해야 합니다.  
목표 함수의 도함수를 계산하기 위해 연쇄 법칙을 사용합니다.

도함수 계산:

두 가지 컴포넌트를 포함:
거리의 변화량을 계산하는 첫 번째 항. 변환에 따라 달라지는 두 번째 항.

최적화 과정:

다양한 초기 위치에서 최적화를 재시작하고, 최적 우도를 선택하는 방식.

<img width="745" alt="스크린샷 2025-06-16 오후 10 23 39" src="https://github.com/user-attachments/assets/0adb779b-b2fd-4e28-9f4f-782282c90064" />

신뢰할 수 있는 최적화의 수렴이 보장되지 않는 점은 아쉬운 사항입니다. Snake 모델의 경우, 다음과 같은 방법으로 문제를 해결할 수 있습니다:

다양한 시작점 사용: 여러 위치에서 최적화를 재시작하여 전체 최대 로그 가능성을 가진 솔루션을 선택합니다.

초기화 개선: 예를 들어, 초기 위치를 얼굴 탐지기의 출력을 바탕으로 설정할 수 있습니다.

사전 지식 적용: 가능한 변환 파라미터에 대한 사전 지식을 사용하여 솔루션의 범위를 제한하고 최대 사후 확률(maximum a posteriori) 공식을 적용할 수 있습니다.

이와 같은 방법들을 통해 최적화 과정에서의 신뢰성을 높일 수 있습니다.

### Inference with iterative closest point algorithm
템플릿 모델을 추정할 때 사용하는 반복적 가장 가까운 점(ICP) 알고리즘 : iterative closest point (ICP) algorithm 에 대한 것입니다. 

ICP 알고리즘은 이미지의 랜드마크 점과 모델의 랜드마크 점을 일치시키며, 최적의 변환을 찾는 방법입니다.

단계별 절차:

매 랜드마크 점 ( $w_n$ )을 현재 매개변수 ( $\Psi$ )를 사용하여 변환합니다.
변환된 점 ( $w'_n$ )을 가장 가까운 이미지 점 ( $y_n$ )과 연결합니다.
랜드마크 점과 이미지 점의 최적 매핑을 계산하여 매개변수 ( $\Psi$ )를 업데이트합니다.
이 과정을 수렴할 때까지 반복합니다.
데이터 연관: 반복하는 과정에서 선택된 최근접 점이 변동하며, 이에 따라 변환 매개변수도 변화합니다.

변형된 접근법: 랜드마크 점을 윤곽선에 수직인 방향으로 매칭하는 방법도 고려되며, 이는 검색을 1D로 제한하여 더 견고한 적합을 가능하게 합니다. 이는 일반적으로 부드러운 윤곽 모델에 유용합니다.

<img width="745" alt="스크린샷 2025-06-17 오전 11 15 08" src="https://github.com/user-attachments/assets/f3a599f2-adc2-4d7e-90bb-913f2544f78d" />

이러한 알고리즘을 통해 템플릿 모델링의 정확성을 높일 수 있습니다.

## Statistical shape models
통계적 형태 모델(statistical shape models), 능동 형태 모델(active shape models), 혹은 점 분포 모델(point distribution models)에 대한 것.

이 모델들은 특정 클래스의 객체 내 변화를 설명하며, 이전에 본 적이 없는 특정 개체에게도 적응할 수 있습니다.

모델은 N개의 랜드마크 포인트의 위치 ${wn}N, n=1$로 형태를 설명하며, 이러한 점들의 가능성은 이미지 내 엣지에 대한 근접성에 따라 달라집니다.  
이때 훈련 이미지 데이터 xi에 대한 가능성(likelihood)은 정의할 수 있습니다.

여기서 $win$은 i번째 훈련 이미지의 n번째 랜드마크 포인트이며, $dist[•,•]$는 이미지 내 가장 가까운 Canny 엣지까지의 거리를 계산하는 함수입니다.

또한 랜드마크 포지션에 대한 복합 벡터 $w_i$를 정의하고, 이것의 밀도 $Pr(wi)$를 정규 분포로 모델링하여 평균 µ와 공분산 Σ를 통해 객체의 평균 형상과 다양한 변화를 설명합니다.

이 모델은 템플릿 모델과 스네이크 모델의 중간에 위치하여, 특정 클래스 내에서 변화하는 형태를 효과적으로 다루는 데 유용합니다.

### Learning
학습의 목표는 훈련 데이터를 기반으로 매개변수 θ = {µ, Σ}를 추정하는 것입니다. 각 훈련 예제는 수작업으로 주석이 달린 여러 랜드마크 점들로 구성됩니다. 그러나 훈련 예제는 일반적으로 기하학적으로 정렬되지 않은 상태로 제공됩니다.

즉, 우리는 변형된 데이터 예를 $w'ᵢ = [wᵀᵢ₁, wᵀᵢ₂, ..., wᵀᵢₙ]ᵀ$ 형태로 수신하며, 이는 변환될 수 있습니다.

여기서 파라미터 µ와 Σ의 정규 분포를 학습하기 전에, 우리는 이 예제들을 역변환을 사용하여 정렬해야 합니다.

여기서 ${Ψ^{-1}_i}$는 역변환의 매개변수입니다. 이와 같은 정렬 과정을 통해 모델 학습에 필요한 정확한 데이터를 확보할 수 있습니다.

#### Alignment of training examples
- Procrustes analysis
주어진 훈련 샘플들을 정렬하는 방법으로, 평균 형태(µ)를 추정하고 변환 매개변수(Ψ)를 반복적으로 업데이트하는 과정을 포함합니다. 요약하자면:

변환 매개변수 업데이트:

각 샘플의 변환을 최적화하여 평균 형태 µ와의 차이를 최소화합니다.

평균 템플릿 업데이트:

각 샘플을 변환한 후 평균을 계산해 평균 형태를 갱신합니다. 이후 이 평균 벡터를 정규화해야 고유한 절대 크기를 정의할 수 있습니다.  
최적의 결과를 얻기 위해 이 두 단계를 반복하며, 수렴에 도달한 후 통계 모델을 적합할 수 있습니다. 이 방법은 얼굴 형태 모델과 같은 다양한 응용 분야에 활용됩니다.

<img width="745" alt="스크린샷 2025-06-17 오전 11 31 16" src="https://github.com/user-attachments/assets/9ce91290-3d80-4851-87d1-e1d665a07763" />

### Inference
모델 적합화: 랜드마크 포인트와 변환 파라미터를 최적화하여 이미지와 일치시키는 것이 목표입니다.

교대 최적화 기법: 고정된 랜드마크 포인트로 변환 매개변수를 추정하고, 고정된 변환 매개변수로 랜드마크 포인트를 추정하는 과정을 반복합니다.

통계적 형태 모델: 이미지의 특성에 맞게 모델의 형태를 조정할 수 있는 장점이 있지만, 변수의 수가 많아 최적화 과정이 비용이 크다는 단점이 있습니다.

모델 간소화의 필요성: 변수가 많고 훈련 데이터가 필요한 문제를 해결하기 위해 더 적은 변수를 사용하는 모델에 대한 설명이 이어질 것입니다.

이와 같은 접근 방법은 이미지 내 물체의 변형에 대응할 수 있도록 하는 데 효과적일 수 있지만, 컴퓨팅 자원과 데이터 세트의 제약을 고려해야 한다는 점이 매우 중요합니다.

